<div class="app-container">
<!-- SVG ICONS template -->
<svg style="display: none;">
  <symbol id="menu-dashboard" viewBox="0 0 24 24">
    <path d="M3 13h8V3H3v10zm0 8h8v-6H3v6zm10 0h8V11h-8v10zm0-18v6h8V3h-8z"/>
  </symbol>
  <symbol id="menu-list" viewBox="0 0 24 24">
    <path d="M3 13h2v-2H3v2zm0 4h2v-2H3v2zm0-8h2V7H3v2zm4 4h14v-2H7v2zm0 4h14v-2H7v2zM7 7v2h14V7H7z"/>
  </symbol>
  <symbol id="menu-product" viewBox="0 0 24 24">
    <path d="M21.41 11.58l-9-9C12.05 2.22 11.55 2 11 2H4c-1.1 0-2 .9-2 2v7c0 .55.22 1.05.59 1.42l9 9c.36.36.86.58 1.41.58.55 0 1.05-.22 1.41-.59l7-7c.37-.36.59-.86.59-1.41 0-.55-.23-1.06-.59-1.42zM5.5 7C4.67 7 4 6.33 4 5.5S4.67 4 5.5 4 7 4.67 7 5.5 6.33 7 5.5 7z"/>
  </symbol>
  <symbol id="menu-customer" viewBox="0 0 24 24">
    <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
  </symbol>
  <symbol id="menu-order" viewBox="0 0 24 24">
    <path d="M13 12h7v1.5h-7V12zm0-2.5h7V11h-7V9.5zm7 5h-7V16h7v-1.5zM19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V8h14v11z"/>
  </symbol>
  <symbol id="menu-comment" viewBox="0 0 24 24">
    <path d="M20 2H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h14l4 4V4c0-1.1-.9-2-2-2zm-2 12H6v-2h12v2zm0-3H6V9h12v2zm0-3H6V6h12v2z"/>
  </symbol>
  <symbol id="menu-discount" viewBox="0 0 24 24">
    <path d="M12.79 21L3 11.21v2c0 .53.21 1.04.59 1.41l7.79 7.79c.78.78 2.05.78 2.83 0l6.21-6.21c.78-.78.78-2.05 0-2.83L12.79 21z"/>
    <path d="M3 9.21v2c0 .53.21 1.04.59 1.41l7.79 7.79c.78.78 2.05.78 2.83 0l6.21-6.21c.78-.78.78-2.05 0-2.83L12.79 1.41A1.996 1.996 0 0 0 11.21 1H5c-1.1 0-2 .9-2 2v6.21zM7.5 8C6.67 8 6 7.33 6 6.5S6.67 5 7.5 5 9 5.67 9 6.5 8.33 8 7.5 8z"/>
  </symbol>
  <symbol id="logout-icon" viewBox="0 0 24 24">
    <path d="M17 7l-1.41 1.41L18.17 11H8v2h10.17l-2.58 2.58L17 17l5-5zM4 5h8V3H4c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h8v-2H4V5z"/>
  </symbol>
  <symbol id="search-icon" viewBox="0 0 24 24">
    <path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/>
  </symbol>
</svg>
  <aside class="sidebar">
    <div class="logo">
      <span class="logo-text"><img src="/images/logo.png" width="100px"></span>
    </div>
    <nav class="sidebar-menu">
      <a class="menu-item" [routerLink]="['/thongke']"><span class="icon menu-dashboard"></span> Bảng điều khiển</a>
      <a class="menu-item" [routerLink]="['/quanlydanhmuc']"><span class="icon menu-list"></span> Danh mục</a>
      <a class="menu-item active" [routerLink]="['/quanlysanpham']"><span class="icon menu-product"></span> Sản phẩm</a>
      <a class="menu-item" [routerLink]="['/quanlynguoidung']"><span class="icon menu-customer"></span> Khách hàng</a>
      <a class="menu-item" [routerLink]="['/quanlydonhang']"><span class="icon menu-order"></span> Đơn hàng</a>
      <a class="menu-item" [routerLink]="['/quanlygiamgia']"><span class="icon menu-list"></span> Chương trình giảm giá</a>
      <a class="menu-item" [routerLink]="['/quanlybinhluan']"><span class="icon menu-comment"></span> Bình luận</a>
    </nav>
    <div class="sidebar-bottom">
      <a class="logout" (click)="logout()"><svg class="logout-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><use xlink:href="#logout-icon"></use></svg> Đăng xuất</a>
    </div>
  </aside>

  <div class="main-container">
    <header class="main-header">
      <div class="header-left">
        <div class="page-title">Quản lý sản phẩm</div>
        <div class="breadcrumb">Home / Sản phẩm</div>
      </div>
      <div class="header-right">
        <div class="search-box">
          <span class="icon search-icon"></span>
          <input type="text" placeholder="Tìm kiếm sản phẩm" [(ngModel)]="searchQuery" name="searchQuery" (input)="search()" />
        </div>
        <img class="avatar" src="/images/avt.png" alt="avatar">
      </div>
    </header>

    <main class="dashboard-content">
      <div *ngIf="errorMessage" class="alert alert-danger">
        {{ errorMessage }}
      </div>

      <section class="products-section">
        <div class="section-header">
          <h2>Danh sách sản phẩm</h2>
          <div class="header-actions">
            <label class="toggle-hidden">
              <input type="checkbox" [(ngModel)]="showHiddenProducts" (change)="toggleShowHidden()">
              Hiển thị sản phẩm đã ẩn
            </label>
            <button class="add-button" (click)="showAddForm()">Thêm sản phẩm</button>
          </div>
        </div>
        <div class="table-wrapper">
          <table>
            <thead>
              <tr>
                <th>STT</th>
                <th>Tên sản phẩm</th>
                <th>Slug</th>
                <th>Giá</th>
                <th>Giá giảm</th>
                <th>Danh mục</th>
                <th>Biến thể</th>
                <th>Thumbnail</th>
                <th>Hành động</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let product of displayedProducts; index as i" [class.hidden-product]="product.isHidden">
                <td>{{ (currentPage - 1) * productsPerPage + i + 1 }}</td>
                <td>{{ product.name }}</td>
                <td>{{ product.slug }}</td>
                <td>{{ product.price }}</td>
                <td>{{ product.salePrice || 'N/A' }}</td>
                <td>{{ (categories | findCategory:product.categoryId)?.name || 'N/A' }}</td>
                <td>
                  <span *ngIf="product.variants && product.variants.length">{{ product.variants.length }} biến thể</span>
                  <span *ngIf="!product.variants || !product.variants.length">Không có</span>
                </td>
                <td>
                  <img *ngIf="product.thumbnail" [src]="'http://localhost:3000' + product.thumbnail" alt="thumbnail" width="50" />
                  <span *ngIf="!product.thumbnail">Không có ảnh</span>
                </td>
                <td class="action-buttons">
                  <button class="action-button edit-button" (click)="showEditForm(product)">
                    <i class="fas fa-edit"></i>
                    <span>Sửa</span>
                  </button>
                  <button class="action-button hide-button" (click)="deleteProduct(product._id!)" [title]="product.isHidden ? 'Hiện sản phẩm' : 'Ẩn sản phẩm'">
                    <i class="fas" [ngClass]="product.isHidden ? 'fa-eye' : 'fa-eye-slash'"></i>
                    <span>{{ product.isHidden ? 'Hiện' : 'Ẩn' }}</span>
                  </button>
                </td>
              </tr>
              <tr *ngIf="displayedProducts.length === 0">
                <td colspan="9">Không có sản phẩm nào.</td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- Phân trang -->
        <div class="pagination" *ngIf="totalPages > 1">
          <button
            [disabled]="currentPage === 1"
            (click)="previousPage()"
            class="pagination-btn"
          >
            Trước
          </button>
          <button
            *ngFor="let page of getPageNumbers()"
            (click)="goToPage(page)"
            [class.active]="page === currentPage"
            class="pagination-btn"
          >
            {{ page }}
          </button>
          <button
            [disabled]="currentPage === totalPages"
            (click)="nextPage()"
            class="pagination-btn"
          >
            Sau
          </button>
        </div>
      </section>

      <!-- Modal Popup cho Form -->
      <div class="modal" *ngIf="showForm" (click)="closeForm()">
        <div class="modal-content" (click)="$event.stopPropagation()">
          <span class="close-button" (click)="closeForm()">×</span>
          <h2>{{ editMode ? 'Sửa sản phẩm' : 'Thêm sản phẩm' }}</h2>
          <form>
            <div class="form-group">
              <label for="name">Tên sản phẩm</label>
              <input id="name" type="text" [(ngModel)]="currentProduct.name" name="name" required />
            </div>
            <div class="form-group">
              <label for="slug">Slug</label>
              <input id="slug" type="text" [(ngModel)]="currentProduct.slug" name="slug" required />
            </div>
            <div class="form-group">
              <label for="description">Mô tả</label>
              <textarea id="description" [(ngModel)]="currentProduct.description" name="description" required></textarea>
            </div>
            <div class="form-group">
              <label for="price">Giá</label>
              <input id="price" type="number" [(ngModel)]="currentProduct.price" name="price" required min="0" />
            </div>
            <div class="form-group">
              <label for="salePrice">Giá giảm</label>
              <input id="salePrice" type="number" [(ngModel)]="currentProduct.salePrice" name="salePrice" min="0" />
            </div>
            <div class="form-group">
              <label for="categoryId">Danh mục</label>
              <select id="categoryId" [(ngModel)]="currentProduct.categoryId" name="categoryId" required>
                <option value="">Chọn danh mục</option>
                <option *ngFor="let category of categories" [value]="category._id">{{ category.name }}</option>
              </select>
            </div>
            <div class="form-group">
              <label for="thumbnail">Ảnh thumbnail</label>
              <input id="thumbnail" type="file" (change)="onThumbnailChange($event)" accept="image/*" />
              <img *ngIf="currentProduct.thumbnailUrl" [src]="currentProduct.thumbnailUrl" alt="preview" width="100" />
            </div>
            <div class="form-group">
              <label for="images">Ảnh bổ sung</label>
              <input id="images" type="file" (change)="onImagesChange($event)" accept="image/*" multiple />
              <div class="image-preview" *ngIf="currentProduct.imageUrls?.length">
                <img *ngFor="let url of currentProduct.imageUrls" [src]="url" alt="preview" width="100" />
              </div>
            </div>

            <!-- Variants Section -->
            <div class="form-group">
              <div class="variants-header">
                <label>Biến thể sản phẩm ({{ currentProduct.variants?.length || 0 }})</label>
                <button type="button" class="add-variant-btn" (click)="addVariant()" style="background: red; color: white;">+ Thêm biến thể (Click me!)</button>
              </div>
              <div class="variants-container" *ngIf="currentProduct.variants && currentProduct.variants.length > 0">
                <div class="variant-item" *ngFor="let variant of currentProduct.variants; let i = index; trackBy: trackByVariantId">
                  <!-- Debug info -->
                  <div style="background: yellow; padding: 5px; margin: 5px;">
                    Debug: Variant {{i}} - ID: {{variant._id}} - Size: {{variant.size}}
                  </div>
                  <div class="variant-header">
                    <h4>Biến thể {{ i + 1 }}</h4>
                    <button type="button" class="remove-variant-btn" (click)="removeVariant(i)">×</button>
                  </div>
                  <div class="variant-fields">
                    <div class="variant-field">
                      <label>Kích thước:</label>
                      <input type="text" [ngModel]="variant.size" (ngModelChange)="variant.size = $event" [name]="'size_' + i" placeholder="VD: S, M, L, XL" />
                    </div>
                    <div class="variant-field">
                      <label>Giá:</label>
                      <input type="number" [ngModel]="variant.price" (ngModelChange)="variant.price = $event" [name]="'price_' + i" min="0" placeholder="0" />
                    </div>
                    <div class="variant-field">
                      <label>Giá giảm:</label>
                      <input type="number" [ngModel]="variant.salePrice" (ngModelChange)="variant.salePrice = $event" [name]="'salePrice_' + i" min="0" placeholder="0" />
                    </div>
                    <div class="variant-field">
                      <label>Số lượng:</label>
                      <input type="number" [ngModel]="variant.stock" (ngModelChange)="variant.stock = $event" [name]="'stock_' + i" min="0" placeholder="0" />
                    </div>
                  </div>
                </div>
              </div>
              <div class="no-variants" *ngIf="!currentProduct.variants || currentProduct.variants.length === 0">
                <p>Chưa có biến thể nào. Nhấn "Thêm biến thể" để tạo.</p>
                <p style="background: yellow; padding: 5px;">Debug: currentProduct.variants = {{ currentProduct.variants | json }}</p>
              </div>
            </div>

            <div class="form-actions">
              <button type="button" (click)="saveProduct()">{{ editMode ? 'Cập nhật' : 'Thêm' }}</button>
              <button type="button" (click)="closeForm()">Hủy</button>
            </div>
          </form>
        </div>
      </div>
    </main>
  </div>
</div>

<!-- SVG ICONS template -->
<svg style="display: none;">
  <symbol id="menu-dashboard" viewBox="0 0 24 24">
    <path d="M3 13h8V3H3v10zm0 8h8v-6H3v6zm10 0h8V11h-8v10zm0-18v6h8V3h-8z" fill="#b3b8c5"/>
  </symbol>
  <symbol id="menu-list" viewBox="0 0 24 24">
    <path d="M3 13h2v-2H3v2zm0 4h2v-2H3v2zm0-8h2V7H3v2zm4 4h14v-2H7v2zm0 4h14v-2H7v2zM7 7v2h14V7H7z" fill="#b3b8c5"/>
  </symbol>
  <symbol id="menu-product" viewBox="0 0 24 24">
    <path d="M21.41 11.58l-9-9C12.05 2.22 11.55 2 11 2H4c-1.1 0-2 .9-2 2v7c0 .55.22 1.05.59 1.42l9 9c.36.36.86.58 1.41.58.55 0 1.05-.22 1.41-.59l7-7c.37-.36.59-.86.59-1.41 0-.55-.23-1.06-.59-1.42zM5.5 7C4.67 7 4 6.33 4 5.5S4.67 4 5.5 4 7 4.67 7 5.5 6.33 7 5.5 7z" fill="#b3b8c5"/>
  </symbol>
  <symbol id="menu-customer" viewBox="0 0 24 24">
    <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z" fill="#b3b8c5"/>
  </symbol>
  <symbol id="menu-order" viewBox="0 0 24 24">
    <path d="M13 12h7v1.5h-7V12zm0-2.5h7V11h-7V9.5zm7 5h-7V16h7v-1.5zM19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V8h14v11z" fill="#b3b8c5"/>
  </symbol>
  <symbol id="menu-comment" viewBox="0 0 24 24">
    <path d="M20 2H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h14l4 4V4c0-1.1-.9-2-2-2zm-2 12H6v-2h12v2zm0-3H6V9h12v2zm0-3H6V6h12v2z" fill="#b3b8c5"/>
  </symbol>
  <symbol id="logout-icon" viewBox="0 0 24 24">
    <path d="M17 7l-1.41 1.41L18.17 11H8v2h10.17l-2.58 2.58L17 17l5-5zM4 5h8V3H4c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h8v-2H4V5z" fill="#b3b8c5"/>
  </symbol>
  <symbol id="search-icon" viewBox="0 0 24 24">
    <path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z" fill="#b3b8c5"/>
  </symbol>
</svg>
