<div class="app-container">
  <aside class="sidebar">
    <div class="logo">
      <span class="logo-text"><img src="/images/logo.png" width="100px"></span>
    </div>
    <nav class="sidebar-menu">
      <a class="menu-item" [routerLink]="['/thongke']"><span class="icon menu-dashboard"></span> B·∫£ng ƒëi·ªÅu khi·ªÉn</a>
      <a class="menu-item" [routerLink]="['/quanlydanhmuc']"><span class="icon menu-list"></span> Danh m·ª•c</a>
      <a class="menu-item" [routerLink]="['/quanlysanpham']"><span class="icon menu-product"></span> S·∫£n ph·∫©m</a>
      <a class="menu-item" [routerLink]="['/quanlynguoidung']"><span class="icon menu-customer"></span> Kh√°ch h√†ng</a>
      <a class="menu-item active" [routerLink]="['/quanlydonhang']"><span class="icon menu-order"></span> ƒê∆°n h√†ng</a>
      <a class="menu-item" [routerLink]="['/quanlygiamgia']"><span class="icon menu-list"></span> Ch∆∞∆°ng tr√¨nh gi·∫£m gi√°</a>
      <a class="menu-item" [routerLink]="['/quanlybinhluan']"><span class="icon menu-comment"></span> B√¨nh lu·∫≠n</a>
    </nav>
    <div class="sidebar-bottom">
      <a class="logout" (click)="logout()"><span class="icon logout-icon"></span> ƒêƒÉng xu·∫•t</a>
    </div>
  </aside>

  <div class="main-container">
    <header class="main-header">
      <div class="header-left">
        <div class="page-title">Qu·∫£n l√Ω ƒë∆°n h√†ng</div>
        <div class="breadcrumb">Home / ƒê∆°n h√†ng</div>
      </div>
      <div class="header-right">
        <div class="search-box">
          <span class="icon search-icon"></span>
          <input type="text" placeholder="T√¨m ki·∫øm ƒë∆°n h√†ng..." [(ngModel)]="searchQuery" (input)="search()" />
        </div>
        <img class="avatar" [src]="userAvatar" alt="avatar">
      </div>
    </header>

    <main class="dashboard-content">
      <!-- Th·ªëng k√™ ƒë∆°n h√†ng -->
      <section class="stats-section">
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-icon total">
              <span class="icon">üì¶</span>
            </div>
            <div class="stat-content">
              <div class="stat-number">{{ orderStats.total }}</div>
              <div class="stat-label">T·ªïng ƒë∆°n h√†ng</div>
            </div>
          </div>
          <div class="stat-card">
            <div class="stat-icon pending">
              <span class="icon">‚è≥</span>
            </div>
            <div class="stat-content">
              <div class="stat-number">{{ orderStats.pending }}</div>
              <div class="stat-label">Ch·ªù x√°c nh·∫≠n</div>
            </div>
          </div>
          <div class="stat-card">
            <div class="stat-icon processing">
              <span class="icon">üîß</span>
            </div>
            <div class="stat-content">
              <div class="stat-number">{{ orderStats.processing }}</div>
              <div class="stat-label">ƒêang chu·∫©n b·ªã</div>
            </div>
          </div>
          <div class="stat-card">
            <div class="stat-icon shipping">
              <span class="icon">üöö</span>
            </div>
            <div class="stat-content">
              <div class="stat-number">{{ orderStats.shipping }}</div>
              <div class="stat-label">ƒêang giao</div>
            </div>
          </div>
          <div class="stat-card">
            <div class="stat-icon delivered">
              <span class="icon">‚úÖ</span>
            </div>
            <div class="stat-content">
              <div class="stat-number">{{ orderStats.delivered }}</div>
              <div class="stat-label">ƒê√£ giao</div>
            </div>
          </div>
          <div class="stat-card">
            <div class="stat-icon completed">
              <span class="icon">üéâ</span>
            </div>
            <div class="stat-content">
              <div class="stat-number">{{ orderStats.completed }}</div>
              <div class="stat-label">Ho√†n th√†nh</div>
            </div>
          </div>
        </div>
      </section>

      <!-- B·ªô l·ªçc v√† s·∫Øp x·∫øp -->
      <section class="filters-section">
        <div class="filters-container">
          <div class="filter-group">
            <label for="statusFilter">L·ªçc theo tr·∫°ng th√°i:</label>
            <select id="statusFilter" [(ngModel)]="statusFilter" (change)="onStatusFilterChange()" class="filter-select">
              <option value="all">T·∫•t c·∫£ tr·∫°ng th√°i</option>
              <option value="Ch·ªù x√°c nh·∫≠n">Ch·ªù x√°c nh·∫≠n</option>
              <option value="ƒêang chu·∫©n b·ªã">ƒêang chu·∫©n b·ªã</option>
              <option value="ƒêang giao">ƒêang giao</option>
              <option value="ƒê√£ giao">ƒê√£ giao</option>
              <option value="ƒê√£ h·ªßy">ƒê√£ h·ªßy</option>
              <option value="ƒê√£ ho√†n th√†nh">ƒê√£ ho√†n th√†nh</option>
            </select>
          </div>
          <div class="filter-group">
            <label for="sortBy">S·∫Øp x·∫øp theo:</label>
            <select id="sortBy" [(ngModel)]="sortBy" (change)="onSortChange()" class="filter-select">
              <option value="createdAt">Ng√†y t·∫°o</option>
              <option value="customerName">T√™n kh√°ch h√†ng</option>
              <option value="total">T·ªïng ti·ªÅn</option>
              <option value="status">Tr·∫°ng th√°i</option>
            </select>
          </div>
          <div class="filter-group">
            <label for="sortOrder">Th·ª© t·ª±:</label>
            <select id="sortOrder" [(ngModel)]="sortOrder" (change)="onSortChange()" class="filter-select">
              <option value="desc">Gi·∫£m d·∫ßn</option>
              <option value="asc">TƒÉng d·∫ßn</option>
            </select>
          </div>
        </div>
      </section>

      <!-- Th√¥ng b√°o l·ªói -->
      <div *ngIf="errorMessage" class="alert alert-danger">
        {{ errorMessage }}
      </div>

      <!-- Loading spinner -->
      <div *ngIf="isLoading" class="loading-container">
        <div class="loading-spinner"></div>
        <p>ƒêang t·∫£i d·ªØ li·ªáu...</p>
      </div>

      <!-- B·∫£ng ƒë∆°n h√†ng -->
      <section class="orders-section" *ngIf="!isLoading">
        <div class="section-header">
          <h2>Danh s√°ch ƒë∆°n h√†ng</h2>
          <div class="results-info">
            Hi·ªÉn th·ªã {{ (currentPage - 1) * itemsPerPage + 1 }}-{{ Math.min(currentPage * itemsPerPage, filteredOrders.length) }} 
            trong t·ªïng s·ªë {{ filteredOrders.length }} ƒë∆°n h√†ng
          </div>
        </div>
        
        <div class="table-wrapper">
          <table>
            <thead>
              <tr>
                <th>STT</th>
                <th>Kh√°ch h√†ng</th>
                <th>Th√¥ng tin li√™n h·ªá</th>
                <th>T·ªïng ti·ªÅn</th>
                <th>Tr·∫°ng th√°i</th>
                <th>Ng√†y t·∫°o</th>
                <th>H√†nh ƒë·ªông</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let order of paginatedOrders; index as i">
                <td>{{ (currentPage - 1) * itemsPerPage + i + 1 }}</td>
                <td>
                  <div class="customer-info">
                    <div class="customer-name">{{ order.customerName || 'Ch∆∞a c·∫≠p nh·∫≠t' }}</div>
                    <div class="customer-note" *ngIf="order.customerNote">
                      <small>{{ order.customerNote }}</small>
                    </div>
                  </div>
                </td>
                <td>
                  <div class="contact-info">
                    <div class="contact-item">
                      <span class="contact-label">Email:</span>
                      <span class="contact-value">{{ order.customerEmail }}</span>
                    </div>
                    <div class="contact-item">
                      <span class="contact-label">SƒêT:</span>
                      <span class="contact-value">{{ order.customerPhone }}</span>
                    </div>
                    <div class="contact-item">
                      <span class="contact-label">ƒê·ªãa ch·ªâ:</span>
                      <span class="contact-value">{{ order.customerAddress }}</span>
                    </div>
                  </div>
                </td>
                <td>
                  <div class="total-amount">
                    {{ order.total | currency:'VND':'symbol':'1.0-0' }}
                  </div>
                </td>
                <td>
                  <div class="status-badge" [class]="getStatusBadgeClass(order.status)">
                    {{ order.status }}
                  </div>
                </td>
                <td>
                  <div class="date-info">
                    {{ formatDate(order.createdAt || '') }}
                  </div>
                </td>
                <td>
                  <div class="action-container">
                    <!-- N√∫t x√°c nh·∫≠n ch·ªâ hi·ªÉn th·ªã khi ƒë∆°n h√†ng ƒëang ch·ªù x√°c nh·∫≠n -->
                    <button 
                      *ngIf="order.status === 'Ch·ªù x√°c nh·∫≠n'"
                      class="confirm-button" 
                      (click)="confirmOrder(order._id!)">
                      <span class="icon">‚úÖ</span>
                      X√°c nh·∫≠n
                    </button>
                    
                    <!-- Dropdown ch·ªâ hi·ªÉn th·ªã cho c√°c tr·∫°ng th√°i kh√°c (kh√¥ng bao g·ªìm ƒë√£ h·ªßy v√† ƒë√£ ho√†n th√†nh) -->
                    <select 
                      *ngIf="canShowDropdown(order.status)"
                      class="action-select" 
                      (change)="updateOrderStatus(order._id!, $event)" 
                      [value]="order.status">
                      <option value="ƒêang chu·∫©n b·ªã">ƒêang chu·∫©n b·ªã</option>
                      <option value="ƒêang giao">ƒêang giao</option>
                      <option value="ƒê√£ giao">ƒê√£ giao</option>
                      <option value="ƒê√£ h·ªßy" *ngIf="canShowCancelOption(order.status)">ƒê√£ h·ªßy</option>
                      <option value="ƒê√£ ho√†n th√†nh">ƒê√£ ho√†n th√†nh</option>
                    </select>
                    
                    <!-- Hi·ªÉn th·ªã tr·∫°ng th√°i ƒë√£ ho√†n th√†nh kh√¥ng th·ªÉ thay ƒë·ªïi -->
                    <div *ngIf="order.status === 'ƒê√£ ho√†n th√†nh'" class="completed-status">
                      <span class="status-badge badge-completed">ƒê√£ ho√†n th√†nh</span>
                      <small class="status-note">Kh√¥ng th·ªÉ thay ƒë·ªïi</small>
                    </div>
                    
                    <!-- Hi·ªÉn th·ªã tr·∫°ng th√°i ƒë√£ h·ªßy kh√¥ng th·ªÉ thay ƒë·ªïi -->
                    <div *ngIf="order.status === 'ƒê√£ h·ªßy'" class="cancelled-status">
                      <span class="status-badge badge-danger">ƒê√£ h·ªßy</span>
                      <small class="status-note">Kh√¥ng th·ªÉ thay ƒë·ªïi</small>
                    </div>
                    
                    <button class="detail-button" (click)="viewOrderDetails(order._id!)">
                      <span class="icon">üëÅÔ∏è</span>
                      Chi ti·∫øt
                    </button>
                  </div>
                </td>
              </tr>
              <tr *ngIf="paginatedOrders.length === 0">
                <td colspan="7" class="no-data">
                  <div class="no-data-content">
                    <span class="icon">üì≠</span>
                    <p>Kh√¥ng c√≥ ƒë∆°n h√†ng n√†o.</p>
                  </div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- Ph√¢n trang -->
        <div class="pagination-container" *ngIf="totalPages > 1">
          <div class="pagination">
            <button 
              class="page-btn" 
              [disabled]="currentPage === 1"
              (click)="changePage(currentPage - 1)">
              ‚Üê Tr∆∞·ªõc
            </button>
            
            <button 
              *ngFor="let page of getPageNumbers()"
              class="page-btn" 
              [class.active]="page === currentPage"
              (click)="changePage(page)">
              {{ page }}
            </button>
            
            <button 
              class="page-btn" 
              [disabled]="currentPage === totalPages"
              (click)="changePage(currentPage + 1)">
              Sau ‚Üí
            </button>
          </div>
          
          <div class="page-info">
            Trang {{ currentPage }} / {{ totalPages }}
          </div>
        </div>
      </section>
    </main>
  </div>
</div>

<!-- SVG ICONS template -->
<svg style="display: none;">
  <symbol id="menu-dashboard" viewBox="0 0 24 24">
    <rect x="3" y="3" width="7" height="7" rx="2" fill="#b3b8c5"/>
    <rect x="3" y="14" width="7" height="7" rx="2" fill="#b3b8c5"/>
    <rect x="14" y="3" width="7" height="7" rx="2" fill="#b3b8c5"/>
    <rect x="14" y="14" width="7" height="7" rx="2" fill="#b3b8c5"/>
  </symbol>
  <symbol id="menu-list" viewBox="0 0 24 24">
    <rect x="4" y="7" width="16" height="2" rx="1" fill="#b3b8c5"/>
    <rect x="4" y="11" width="16" height="2" rx="1" fill="#b3b8c5"/>
    <rect x="4" y="15" width="16" height="2" rx="1" fill="#b3b8c5"/>
  </symbol>
  <symbol id="menu-product" viewBox="0 0 24 24">
    <circle cx="12" cy="12" r="6" stroke="#b3b8c5" stroke-width="2" fill="none"/>
  </symbol>
  <symbol id="menu-customer" viewBox="0 0 24 24">
    <circle cx="12" cy="9" r="5" stroke="#b3b8c5" stroke-width="2" fill="none"/>
    <path d="M3 21c0-4.418 4.03-8 9-8s9 3.582 9 8" stroke="#b3b8c5" stroke-width="2" fill="none"/>
  </symbol>
  <symbol id="menu-order" viewBox="0 0 24 24">
    <rect x="6" y="6" width="12" height="12" rx="2" stroke="#b3b8c5" stroke-width="2" fill="none"/>
  </symbol>
  <symbol id="logout-icon" viewBox="0 0 24 24">
    <path d="M16 17l5-5-5-5M21 12H9M13 7V5a2 2 0 0 0-2-2H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2v-2" stroke="#b3b8c5" stroke-width="2" fill="none"/>
  </symbol>
  <symbol id="search-icon" viewBox="0 0 24 24">
    <circle cx="11" cy="11" r="8" stroke="#b3b8c5" stroke-width="2" fill="none"/>
    <line x1="21" y1="21" x2="16.65" y2="16.65" stroke="#b3b8c5" stroke-width="2"/>
  </symbol>
</svg>