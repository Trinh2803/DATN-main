<div class="app-container">
  <!-- SVG ICONS template -->
  <svg style="display: none;">
    <symbol id="menu-dashboard" viewBox="0 0 24 24">
      <path d="M3 13h8V3H3v10zm0 8h8v-6H3v6zm10 0h8V11h-8v10zm0-18v6h8V3h-8z"/>
    </symbol>
    <symbol id="menu-list" viewBox="0 0 24 24">
      <path d="M3 13h2v-2H3v2zm0 4h2v-2H3v2zm0-8h2V7H3v2zm4 4h14v-2H7v2zm0 4h14v-2H7v2zM7 7v2h14V7H7z"/>
    </symbol>
    <symbol id="menu-product" viewBox="0 0 24 24">
      <path d="M21.41 11.58l-9-9C12.05 2.22 11.55 2 11 2H4c-1.1 0-2 .9-2 2v7c0 .55.22 1.05.59 1.42l9 9c.36.36.86.58 1.41.58.55 0 1.05-.22 1.41-.59l7-7c.37-.36.59-.86.59-1.41 0-.55-.23-1.06-.59-1.42zM5.5 7C4.67 7 4 6.33 4 5.5S4.67 4 5.5 4 7 4.67 7 5.5 6.33 7 5.5 7z"/>
    </symbol>
    <symbol id="menu-customer" viewBox="0 0 24 24">
      <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
    </symbol>
    <symbol id="menu-order" viewBox="0 0 24 24">
      <path d="M13 12h7v1.5h-7V12zm0-2.5h7V11h-7V9.5zm7 5h-7V16h7v-1.5zM19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V8h14v11z"/>
    </symbol>
    <symbol id="menu-comment" viewBox="0 0 24 24">
      <path d="M20 2H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h14l4 4V4c0-1.1-.9-2-2-2zm-2 12H6v-2h12v2zm0-3H6V9h12v2zm0-3H6V6h12v2z"/>
    </symbol>
    <symbol id="logout-icon" viewBox="0 0 24 24">
      <path d="M17 7l-1.41 1.41L18.17 11H8v2h10.17l-2.58 2.58L17 17l5-5zM4 5h8V3H4c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h8v-2H4V5z"/>
    </symbol>
    <symbol id="search-icon" viewBox="0 0 24 24">
      <path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/>
    </symbol>
  </svg>
  <aside class="sidebar">
    <div class="logo">
      <span class="logo-text"><img src="/images/logo.png" width="100px"></span>
    </div>
    <nav class="sidebar-menu">
      <a class="menu-item" [routerLink]="['/thongke']"><span class="icon menu-dashboard"></span> Bảng điều khiển</a>
      <a class="menu-item" [routerLink]="['/quanlydanhmuc']"><span class="icon menu-list"></span> Danh mục</a>
      <a class="menu-item" [routerLink]="['/quanlysanpham']"><span class="icon menu-product"></span> Sản phẩm</a>
      <a class="menu-item" [routerLink]="['/quanlynguoidung']"><span class="icon menu-customer"></span> Khách hàng</a>
      <a class="menu-item" [routerLink]="['/quanlydonhang']"><span class="icon menu-order"></span> Đơn hàng</a>
      <a class="menu-item" [routerLink]="['/quanlygiamgia']"><span class="icon menu-list"></span> Chương trình giảm giá</a>
      <a class="menu-item active" [routerLink]="['/quanlybinhluan']"><span class="icon menu-comment"></span> Bình luận</a>
    </nav>
    <div class="sidebar-bottom">
      <a class="logout" (click)="logout()"><i class="fas fa-sign-out-alt"></i> Đăng xuất</a>
    </div>
  </aside>

  <div class="main-container">
    <header class="main-header">
      <div class="header-left">
        <div class="page-title">Quản lý bình luận</div>
        <div class="breadcrumb">Home / Bình luận</div>
      </div>
      <div class="header-right">
        <div class="search-box">
          <i class="fas fa-search"></i>
          <input type="text" placeholder="Tìm kiếm bình luận..." [(ngModel)]="searchQuery" (input)="search()" />
        </div>
        <img class="avatar" [src]="userAvatar" alt="avatar">
      </div>
    </header>

    <main class="dashboard-content">
      <!-- Header -->
      <div class="header-section">
        <div class="header-content">
          <h2 class="page-title">
            <i class="fas fa-comments"></i>
            Quản lý bình luận
          </h2>
          <div class="user-info">
            <img [src]="userAvatar" alt="User Avatar" class="user-avatar">
            <button class="logout-btn" (click)="logout()">
              <i class="fas fa-sign-out-alt"></i>
              Đăng xuất
            </button>
          </div>
        </div>
      </div>

      <!-- Statistics Cards -->
      <div class="stats-section">
        <div class="stat-card total">
          <div class="stat-content">
            <div class="stat-number">{{ commentStats.total }}</div>
            <div class="stat-label">Tổng bình luận</div>
          </div>
          <div class="stat-icon">
            <i class="fas fa-comments"></i>
          </div>
        </div>
        <div class="stat-card pending">
          <div class="stat-content">
            <div class="stat-number">{{ commentStats.pending }}</div>
            <div class="stat-label">Chờ duyệt</div>
          </div>
          <div class="stat-icon">
            <i class="fas fa-clock"></i>
          </div>
        </div>
        <div class="stat-card approved">
          <div class="stat-content">
            <div class="stat-number">{{ commentStats.approved }}</div>
            <div class="stat-label">Đã duyệt</div>
          </div>
          <div class="stat-icon">
            <i class="fas fa-check-circle"></i>
          </div>
        </div>
        <div class="stat-card rejected">
          <div class="stat-content">
            <div class="stat-number">{{ commentStats.rejected }}</div>
            <div class="stat-label">Từ chối</div>
          </div>
          <div class="stat-icon">
            <i class="fas fa-times-circle"></i>
          </div>
        </div>
      </div>

      <!-- Filters and Search -->
      <div class="filters-section">
        <div class="filters-container">
          <div class="filter-group">
            <label for="searchInput">Tìm kiếm</label>
            <div class="search-input-group">
              <input
                type="text"
                id="searchInput"
                [(ngModel)]="searchQuery"
                placeholder="Tìm theo tên, email, nội dung, sản phẩm..."
                (keyup.enter)="search()"
                >
                <button type="button" (click)="search()">
                  <i class="fas fa-search"></i>
                </button>
              </div>
            </div>
            <div class="filter-group">
              <label for="statusFilter">Trạng thái</label>
              <select
                id="statusFilter"
                [(ngModel)]="statusFilter"
                (change)="onFilterChange()"
                >
                <option value="all">Tất cả</option>
                <option value="pending">Chờ duyệt</option>
                <option value="approved">Đã duyệt</option>
                <option value="rejected">Từ chối</option>
              </select>
            </div>
            <div class="filter-group">
              <label for="ratingFilter">Đánh giá</label>
              <select
                id="ratingFilter"
                [(ngModel)]="ratingFilter"
                (change)="onFilterChange()"
                >
                <option value="0">Tất cả</option>
                <option value="1">1 sao</option>
                <option value="2">2 sao</option>
                <option value="3">3 sao</option>
                <option value="4">4 sao</option>
                <option value="5">5 sao</option>
              </select>
            </div>
            <div class="filter-group">
              <label for="productFilter">Sản phẩm</label>
              <select
                id="productFilter"
                [(ngModel)]="productFilter"
                (change)="onFilterChange()"
                >
                @for (option of productFilterOptions; track option) {
                  <option [value]="option.value">{{ option.label }}</option>
                }
              </select>
            </div>
            <div class="filter-group">
              <label for="sortBy">Sắp xếp theo</label>
              <select
                id="sortBy"
                [(ngModel)]="sortBy"
                (change)="onSortChange()"
                >
                <option value="createdAt">Ngày tạo</option>
                <option value="userName">Tên người dùng</option>
                <option value="rating">Đánh giá</option>
                <option value="status">Trạng thái</option>
                <option value="productName">Tên sản phẩm</option>
              </select>
            </div>
            <div class="filter-group">
              <label for="sortOrder">Thứ tự</label>
              <select
                id="sortOrder"
                [(ngModel)]="sortOrder"
                (change)="onSortChange()"
                >
                <option value="desc">Giảm dần</option>
                <option value="asc">Tăng dần</option>
              </select>
            </div>
          </div>
        </div>

        <!-- Bulk Actions -->
        @if (selectedComments.length > 0) {
          <div class="bulk-actions">
            <div class="bulk-info">
              <span>Đã chọn {{ selectedComments.length }} bình luận</span>
            </div>
            <div class="bulk-buttons">
              <button class="btn-success" (click)="bulkUpdateStatus('approved')">
                <i class="fas fa-check"></i>
                Duyệt tất cả
              </button>
              <button class="btn-danger" (click)="bulkUpdateStatus('rejected')">
                <i class="fas fa-times"></i>
                Từ chối tất cả
              </button>
            </div>
          </div>
        }

        <!-- Comments Table -->
        <div class="table-section">
          <div class="table-container">
            <table class="comments-table">
              <thead>
                <tr>
                  <th width="50">
                    <input
                      type="checkbox"
                      [(ngModel)]="selectAll"
                      (change)="toggleSelectAll()"
                      >
                    </th>
                    <th>Người dùng</th>
                    <th>Sản phẩm</th>
                    <th>Nội dung</th>
                    <th>Đánh giá</th>
                    <th>Trạng thái</th>
                    <th>Ngày tạo</th>
                    <th width="200">Thao tác</th>
                  </tr>
                </thead>
                <tbody>
                  @if (isLoading) {
                    <tr>
                      <td colspan="8" class="loading-cell">
                        <div class="loading-spinner"></div>
                        <span>Đang tải...</span>
                      </td>
                    </tr>
                  }
                  @if (!isLoading && paginatedComments.length === 0) {
                    <tr>
                      <td colspan="8" class="empty-cell">
                        <i class="fas fa-inbox"></i>
                        <p>Không có bình luận nào</p>
                      </td>
                    </tr>
                  }
                  @for (comment of paginatedComments; track comment) {
                    <tr>
                      <td>
                        <input
                          type="checkbox"
                          [checked]="selectedComments.includes(comment._id!)"
                          (change)="toggleCommentSelection(comment._id!)"
                          >
                        </td>
                        <td>
                          <div class="user-info-cell">
                            <div class="user-details">
                              <div class="user-name">{{ comment.userName }}</div>
                              <div class="user-email">{{ comment.userEmail }}</div>
                            </div>
                          </div>
                        </td>
                        <td>
                          <div class="product-info-cell"> <div class="product-details">
                            <div class="product-name">
                              {{ comment.productId?._id === 'homepage' ? 'Trang chủ' : (comment.productId?.name || 'Không xác định') }}
                            </div>
                            <div class="product-id">ID: {{ comment.productId?._id || 'Không xác định' }}</div>
                          </div>
                        </div>
                      </td>
                      <td>
                        {{ comment.content }}
                        @if (comment.adminReply) {
                          <div class="admin-reply">
                            <strong>Trả lời của admin:</strong>
                            {{ comment.adminReply.content }}
                            <small>{{ comment.adminReply.adminId.name || 'Admin không xác định' }} - {{ formatDate(comment.adminReply.repliedAt) }}</small>
                          </div>
                        }
                      </td>
                      <td>
                        <div class="rating-cell">
                          <span class="rating-stars">{{ getRatingStars(comment.rating) }}</span>
                          <small class="rating-text">({{ comment.rating }}/5)</small>
                        </div>
                      </td>
                      <td>
                        <span
                          class="status-badge"
                          [ngClass]="getStatusBadgeClass(comment.status)"
                          [style.background-color]="getStatusColor(comment.status)"
                          >
                          {{ getStatusText(comment.status) }}
                        </span>
                      </td>
                      <td>
                        <div class="date-cell">
                          <div class="date">{{ formatDate(comment.createdAt) }}</div>
                          @if (comment.isEdited) {
                            <small class="edited-info">
                              <span class="icon">✏️</span>
                              Đã chỉnh sửa
                            </small>
                          }
                        </div>
                      </td>
                      <td>
                        <div class="action-buttons">
                          @if (comment.status === 'approved') {
                            <button
                              class="btn-reply"
                              title="Trả lời"
                              (click)="openReplyModal(comment)"
                              >
                              <span class="icon">✅</span>
                            </button>
                          }
                          <button
                            class="btn-edit"
                            title="Chỉnh sửa"
                            (click)="openEditModal(comment)"
                            >
                            <span class="icon">✏️</span>
                          </button>
                          <div class="dropdown">
                            <button class="btn-status dropdown-toggle" title="Thay đổi trạng thái">
                              <span class="icon">⚙️</span>
                            </button>
                            <div class="dropdown-menu">
                              <a class="dropdown-item" (click)="updateCommentStatus(comment._id!, 'approved')">
                                <i class="fas fa-check"></i>
                                Duyệt
                              </a>
                              <a class="dropdown-item" (click)="updateCommentStatus(comment._id!, 'rejected')">
                                <i class="fas fa-times"></i>
                                Từ chối
                              </a>
                            </div>
                          </div>
                          <button
                            class="btn-delete"
                            title="Xóa"
                            (click)="deleteComment(comment._id!)"
                            >
                            <span class="icon">🗑️</span>
                          </button>
                        </div>
                      </td>
                    </tr>
                  }
                </tbody>
              </table>
            </div>

            <!-- Pagination -->
            <div class="pagination-section">
              <div class="pagination-info">
                Hiển thị {{ (currentPage - 1) * itemsPerPage + 1 }} -
                {{ getEndIndex() }}
                trong tổng số {{ filteredComments.length }} bình luận
              </div>
              @if (totalPages > 1) {
                <nav class="pagination">
                  <button
                    class="page-btn"
                    [disabled]="currentPage === 1"
                    (click)="changePage(currentPage - 1)"
                    >
                    <i class="fas fa-chevron-left"></i>
                  </button>
                  @for (page of getPageNumbers(); track page) {
                    <button
                      class="page-btn"
                      [class.active]="page === currentPage"
                      (click)="changePage(page)"
                      >
                      {{ page }}
                    </button>
                  }
                  <button
                    class="page-btn"
                    [disabled]="currentPage === totalPages"
                    (click)="changePage(currentPage + 1)"
                    >
                    <i class="fas fa-chevron-right"></i>
                  </button>
                </nav>
              }
            </div>
          </div>
        </main>
      </div>
    </div>

    <!-- Reply Modal -->
    @if (showReplyModal) {
      <div class="modal" [class.show]="showReplyModal">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">
                <span class="icon">✅</span>
                Trả lời bình luận
              </h5>
              <button type="button" class="modal-close" (click)="closeModal()">×</button>
            </div>
            <div class="modal-body">
              @if (selectedComment) {
                <div class="comment-preview">
                  <h6>Bình luận của {{ selectedComment.userName }}:</h6>
                  <div class="comment-box">
                    <div class="rating-preview">
                      <span class="rating-stars">{{ getRatingStars(selectedComment.rating) }}</span>
                      <small>({{ selectedComment.rating }}/5)</small>
                    </div>
                    <p>{{ selectedComment.content }}</p>
                  </div>
                </div>
              }
              <div class="form-group">
                <label for="replyContent">Nội dung trả lời:</label>
                <textarea
                  id="replyContent"
                  rows="4"
                  [(ngModel)]="replyContent"
                  placeholder="Nhập nội dung trả lời..."
                ></textarea>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn-cancel" (click)="closeModal()">Hủy</button>
              <button type="button" class="btn-primary" (click)="submitReply()">
                <i class="fas fa-paper-plane"></i>
                Gửi trả lời
              </button>
            </div>
          </div>
        </div>
      </div>
    }

    <!-- Edit Modal -->
    @if (showEditModal) {
      <div class="modal" [class.show]="showEditModal">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">
                <span class="icon">✏️</span>
                Chỉnh sửa bình luận
              </h5>
              <button type="button" class="modal-close" (click)="closeModal()">×</button>
            </div>
            <div class="modal-body">
              <div class="form-group">
                <label for="editRating">Đánh giá:</label>
                <select id="editRating" [(ngModel)]="editRating">
                  <option value="1">1 sao</option>
                  <option value="2">2 sao</option>
                  <option value="3">3 sao</option>
                  <option value="4">4 sao</option>
                  <option value="5">5 sao</option>
                </select>
              </div>
              <div class="form-group">
                <label for="editContent">Nội dung:</label>
                <textarea
                  id="editContent"
                  rows="4"
                  [(ngModel)]="editContent"
                  placeholder="Nhập nội dung bình luận..."
                ></textarea>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn-cancel" (click)="closeModal()">Hủy</button>
              <button type="button" class="btn-primary" (click)="submitEdit()">
                <i class="fas fa-save"></i>
                Lưu thay đổi
              </button>
            </div>
          </div>
        </div>
      </div>
    }

    <!-- Modal Backdrop -->
    @if (showReplyModal || showEditModal) {
      <div class="modal-backdrop"></div>
    }
