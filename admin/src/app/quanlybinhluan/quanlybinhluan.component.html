<div class="app-container">
  <aside class="sidebar">
    <div class="logo">
      <span class="logo-text"><img src="assets/images/logo.png" width="100px"></span>
    </div>
    <nav class="sidebar-menu">
      <a class="menu-item" [routerLink]="['/thongke']"><span class="icon menu-dashboard"></span> B·∫£ng ƒëi·ªÅu khi·ªÉn</a>
      <a class="menu-item" [routerLink]="['/quanlydanhmuc']"><span class="icon menu-list"></span> Danh m·ª•c</a>
      <a class="menu-item" [routerLink]="['/quanlysanpham']"><span class="icon menu-product"></span> S·∫£n ph·∫©m</a>
      <a class="menu-item" [routerLink]="['/quanlynguoidung']"><span class="icon menu-customer"></span> Kh√°ch h√†ng</a>
      <a class="menu-item" [routerLink]="['/quanlydonhang']"><span class="icon menu-order"></span> ƒê∆°n h√†ng</a>
      <a class="menu-item" [routerLink]="['/quanlygiamgia']"><span class="icon menu-list"></span> Ch∆∞∆°ng tr√¨nh gi·∫£m gi√°</a>
      <a class="menu-item active" [routerLink]="['/quanlybinhluan']"><span class="icon menu-comment"></span> B√¨nh lu·∫≠n</a>
    </nav>
    <div class="sidebar-bottom">
      <a class="logout" (click)="logout()"><span class="icon logout-icon"></span> ƒêƒÉng xu·∫•t</a>
    </div>
  </aside>

  <div class="main-container">
    <header class="main-header">
      <div class="header-left">
        <div class="page-title">Qu·∫£n l√Ω b√¨nh lu·∫≠n</div>
        <div class="breadcrumb">Home / B√¨nh lu·∫≠n</div>
      </div>
      <div class="header-right">
        <div class="search-box">
          <span class="icon search-icon"></span>
          <input type="text" placeholder="T√¨m ki·∫øm b√¨nh lu·∫≠n..." [(ngModel)]="searchQuery" (input)="search()" />
        </div>
        <img class="avatar" [src]="userAvatar" alt="avatar">
      </div>
    </header>

    <main class="dashboard-content">
      <!-- Header -->
      <div class="header-section">
        <div class="header-content">
          <h2 class="page-title">
            <i class="fas fa-comments"></i>
            Qu·∫£n l√Ω b√¨nh lu·∫≠n
          </h2>
          <div class="user-info">
            <img [src]="userAvatar" alt="User Avatar" class="user-avatar">
            <button class="logout-btn" (click)="logout()">
              <i class="fas fa-sign-out-alt"></i>
              ƒêƒÉng xu·∫•t
            </button>
          </div>
        </div>
      </div>

      <!-- Statistics Cards -->
      <div class="stats-section">
        <div class="stat-card total">
          <div class="stat-content">
            <div class="stat-number">{{ commentStats.total }}</div>
            <div class="stat-label">T·ªïng b√¨nh lu·∫≠n</div>
          </div>
          <div class="stat-icon">
            <i class="fas fa-comments"></i>
          </div>
        </div>
        <div class="stat-card pending">
          <div class="stat-content">
            <div class="stat-number">{{ commentStats.pending }}</div>
            <div class="stat-label">Ch·ªù duy·ªát</div>
          </div>
          <div class="stat-icon">
            <i class="fas fa-clock"></i>
          </div>
        </div>
        <div class="stat-card approved">
          <div class="stat-content">
            <div class="stat-number">{{ commentStats.approved }}</div>
            <div class="stat-label">ƒê√£ duy·ªát</div>
          </div>
          <div class="stat-icon">
            <i class="fas fa-check-circle"></i>
          </div>
        </div>
        <div class="stat-card rejected">
          <div class="stat-content">
            <div class="stat-number">{{ commentStats.rejected }}</div>
            <div class="stat-label">T·ª´ ch·ªëi</div>
          </div>
          <div class="stat-icon">
            <i class="fas fa-times-circle"></i>
          </div>
        </div>
      </div>

      <!-- Filters and Search -->
      <div class="filters-section">
        <div class="filters-container">
          <div class="filter-group">
            <label for="searchInput">T√¨m ki·∫øm</label>
            <div class="search-input-group">
              <input
                type="text"
                id="searchInput"
                [(ngModel)]="searchQuery"
                placeholder="T√¨m theo t√™n, email, n·ªôi dung, s·∫£n ph·∫©m..."
                (keyup.enter)="search()"
              >
              <button type="button" (click)="search()">
                <i class="fas fa-search"></i>
              </button>
            </div>
          </div>
          <div class="filter-group">
            <label for="statusFilter">Tr·∫°ng th√°i</label>
            <select
              id="statusFilter"
              [(ngModel)]="statusFilter"
              (change)="onFilterChange()"
            >
              <option value="all">T·∫•t c·∫£</option>
              <option value="pending">Ch·ªù duy·ªát</option>
              <option value="approved">ƒê√£ duy·ªát</option>
              <option value="rejected">T·ª´ ch·ªëi</option>
            </select>
          </div>
          <div class="filter-group">
            <label for="ratingFilter">ƒê√°nh gi√°</label>
            <select
              id="ratingFilter"
              [(ngModel)]="ratingFilter"
              (change)="onFilterChange()"
            >
              <option value="0">T·∫•t c·∫£</option>
              <option value="1">1 sao</option>
              <option value="2">2 sao</option>
              <option value="3">3 sao</option>
              <option value="4">4 sao</option>
              <option value="5">5 sao</option>
            </select>
          </div>
          <div class="filter-group">
            <label for="productFilter">S·∫£n ph·∫©m</label>
            <select
              id="productFilter"
              [(ngModel)]="productFilter"
              (change)="onFilterChange()"
            >
              <option *ngFor="let option of productFilterOptions" [value]="option.value">{{ option.label }}</option>
            </select>
          </div>
          <div class="filter-group">
            <label for="sortBy">S·∫Øp x·∫øp theo</label>
            <select
              id="sortBy"
              [(ngModel)]="sortBy"
              (change)="onSortChange()"
            >
              <option value="createdAt">Ng√†y t·∫°o</option>
              <option value="userName">T√™n ng∆∞·ªùi d√πng</option>
              <option value="rating">ƒê√°nh gi√°</option>
              <option value="status">Tr·∫°ng th√°i</option>
              <option value="productName">T√™n s·∫£n ph·∫©m</option>
            </select>
          </div>
          <div class="filter-group">
            <label for="sortOrder">Th·ª© t·ª±</label>
            <select
              id="sortOrder"
              [(ngModel)]="sortOrder"
              (change)="onSortChange()"
            >
              <option value="desc">Gi·∫£m d·∫ßn</option>
              <option value="asc">TƒÉng d·∫ßn</option>
            </select>
          </div>
        </div>
      </div>

      <!-- Bulk Actions -->
      <div class="bulk-actions" *ngIf="selectedComments.length > 0">
        <div class="bulk-info">
          <span>ƒê√£ ch·ªçn {{ selectedComments.length }} b√¨nh lu·∫≠n</span>
        </div>
        <div class="bulk-buttons">
          <button class="btn-success" (click)="bulkUpdateStatus('approved')">
            <i class="fas fa-check"></i>
            Duy·ªát t·∫•t c·∫£
          </button>
          <button class="btn-danger" (click)="bulkUpdateStatus('rejected')">
            <i class="fas fa-times"></i>
            T·ª´ ch·ªëi t·∫•t c·∫£
          </button>
        </div>
      </div>

      <!-- Comments Table -->
      <div class="table-section">
        <div class="table-container">
          <table class="comments-table">
            <thead>
              <tr>
                <th width="50">
                  <input
                    type="checkbox"
                    [(ngModel)]="selectAll"
                    (change)="toggleSelectAll()"
                  >
                </th>
                <th>Ng∆∞·ªùi d√πng</th>
                <th>S·∫£n ph·∫©m</th>
                <th>N·ªôi dung</th>
                <th>ƒê√°nh gi√°</th>
                <th>Tr·∫°ng th√°i</th>
                <th>Ng√†y t·∫°o</th>
                <th width="200">Thao t√°c</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngIf="isLoading">
                <td colspan="8" class="loading-cell">
                  <div class="loading-spinner"></div>
                  <span>ƒêang t·∫£i...</span>
                </td>
              </tr>
              <tr *ngIf="!isLoading && paginatedComments.length === 0">
                <td colspan="8" class="empty-cell">
                  <i class="fas fa-inbox"></i>
                  <p>Kh√¥ng c√≥ b√¨nh lu·∫≠n n√†o</p>
                </td>
              </tr>
              <tr *ngFor="let comment of paginatedComments">
                <td>
                  <input
                    type="checkbox"
                    [checked]="selectedComments.includes(comment._id!)"
                    (change)="toggleCommentSelection(comment._id!)"
                  >
                </td>
                <td>
                  <div class="user-info-cell">
                    <div class="avatar-placeholder">
                      <i class="fas fa-user"></i>
                    </div>
                    <div class="user-details">
                      <div class="user-name">{{ comment.userName }}</div>
                      <div class="user-email">{{ comment.userEmail }}</div>
                    </div>
                  </div>
                </td>
                <td>
                  <div class="product-info-cell"> <div class="product-details">
                      <div class="product-name">
                        {{ comment.productId?._id === 'homepage' ? 'Trang ch·ªß' : (comment.productId?.name || 'Kh√¥ng x√°c ƒë·ªãnh') }}
                      </div>
                      <div class="product-id">ID: {{ comment.productId?._id || 'Kh√¥ng x√°c ƒë·ªãnh' }}</div>
                    </div>
                  </div>
                </td>
                <td>
                  {{ comment.content }}
                  <div *ngIf="comment.adminReply" class="admin-reply">
                    <strong>Tr·∫£ l·ªùi c·ªßa admin:</strong>
                    {{ comment.adminReply.content }}
                    <small>{{ comment.adminReply.adminId.name || 'Admin kh√¥ng x√°c ƒë·ªãnh' }} - {{ formatDate(comment.adminReply.repliedAt) }}</small>
                  </div>
                </td>
                <td>
                  <div class="rating-cell">
                    <span class="rating-stars">{{ getRatingStars(comment.rating) }}</span>
                    <small class="rating-text">({{ comment.rating }}/5)</small>
                  </div>
                </td>
                <td>
                  <span
                    class="status-badge"
                    [ngClass]="getStatusBadgeClass(comment.status)"
                    [style.background-color]="getStatusColor(comment.status)"
                  >
                    {{ getStatusText(comment.status) }}
                  </span>
                </td>
                <td>
                  <div class="date-cell">
                    <div class="date">{{ formatDate(comment.createdAt) }}</div>
                    <small class="edited-info" *ngIf="comment.isEdited">
                      <span class="icon">‚úèÔ∏è</span>
                      ƒê√£ ch·ªânh s·ª≠a
                    </small>
                  </div>
                </td>
                <td>
                  <div class="action-buttons">
                    <button
                      class="btn-reply"
                      title="Tr·∫£ l·ªùi"
                      (click)="openReplyModal(comment)"
                      *ngIf="comment.status === 'approved'"
                    >
                      <span class="icon">‚úÖ</span>
                    </button>
                    <button
                      class="btn-edit"
                      title="Ch·ªânh s·ª≠a"
                      (click)="openEditModal(comment)"
                    >
                      <span class="icon">‚úèÔ∏è</span>
                    </button>
                    <div class="dropdown">
                      <button class="btn-status dropdown-toggle" title="Thay ƒë·ªïi tr·∫°ng th√°i">
                        <span class="icon">‚öôÔ∏è</span>
                      </button>
                      <div class="dropdown-menu">
                        <a class="dropdown-item" (click)="updateCommentStatus(comment._id!, 'approved')">
                          <i class="fas fa-check"></i>
                          Duy·ªát
                        </a>
                        <a class="dropdown-item" (click)="updateCommentStatus(comment._id!, 'rejected')">
                          <i class="fas fa-times"></i>
                          T·ª´ ch·ªëi
                        </a>
                      </div>
                    </div>
                    <button
                      class="btn-delete"
                      title="X√≥a"
                      (click)="deleteComment(comment._id!)"
                    >
                      <span class="icon">üóëÔ∏è</span>
                    </button>
                  </div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- Pagination -->
        <div class="pagination-section">
          <div class="pagination-info">
            Hi·ªÉn th·ªã {{ (currentPage - 1) * itemsPerPage + 1 }} -
            {{ getEndIndex() }}
            trong t·ªïng s·ªë {{ filteredComments.length }} b√¨nh lu·∫≠n
          </div>
          <nav class="pagination" *ngIf="totalPages > 1">
            <button
              class="page-btn"
              [disabled]="currentPage === 1"
              (click)="changePage(currentPage - 1)"
            >
              <i class="fas fa-chevron-left"></i>
            </button>
            <button
              *ngFor="let page of getPageNumbers()"
              class="page-btn"
              [class.active]="page === currentPage"
              (click)="changePage(page)"
            >
              {{ page }}
            </button>
            <button
              class="page-btn"
              [disabled]="currentPage === totalPages"
              (click)="changePage(currentPage + 1)"
            >
              <i class="fas fa-chevron-right"></i>
            </button>
          </nav>
        </div>
      </div>
    </main>
  </div>
</div>

<!-- Reply Modal -->
<div class="modal" [class.show]="showReplyModal" *ngIf="showReplyModal">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          <span class="icon">‚úÖ</span>
          Tr·∫£ l·ªùi b√¨nh lu·∫≠n
        </h5>
        <button type="button" class="modal-close" (click)="closeModal()">√ó</button>
      </div>
      <div class="modal-body">
        <div *ngIf="selectedComment" class="comment-preview">
          <h6>B√¨nh lu·∫≠n c·ªßa {{ selectedComment.userName }}:</h6>
          <div class="comment-box">
            <div class="rating-preview">
              <span class="rating-stars">{{ getRatingStars(selectedComment.rating) }}</span>
              <small>({{ selectedComment.rating }}/5)</small>
            </div>
            <p>{{ selectedComment.content }}</p>
          </div>
        </div>
        <div class="form-group">
          <label for="replyContent">N·ªôi dung tr·∫£ l·ªùi:</label>
          <textarea
            id="replyContent"
            rows="4"
            [(ngModel)]="replyContent"
            placeholder="Nh·∫≠p n·ªôi dung tr·∫£ l·ªùi..."
          ></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn-cancel" (click)="closeModal()">H·ªßy</button>
        <button type="button" class="btn-primary" (click)="submitReply()">
          <i class="fas fa-paper-plane"></i>
          G·ª≠i tr·∫£ l·ªùi
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Edit Modal -->
<div class="modal" [class.show]="showEditModal" *ngIf="showEditModal">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          <span class="icon">‚úèÔ∏è</span>
          Ch·ªânh s·ª≠a b√¨nh lu·∫≠n
        </h5>
        <button type="button" class="modal-close" (click)="closeModal()">√ó</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label for="editRating">ƒê√°nh gi√°:</label>
          <select id="editRating" [(ngModel)]="editRating">
            <option value="1">1 sao</option>
            <option value="2">2 sao</option>
            <option value="3">3 sao</option>
            <option value="4">4 sao</option>
            <option value="5">5 sao</option>
          </select>
        </div>
        <div class="form-group">
          <label for="editContent">N·ªôi dung:</label>
          <textarea
            id="editContent"
            rows="4"
            [(ngModel)]="editContent"
            placeholder="Nh·∫≠p n·ªôi dung b√¨nh lu·∫≠n..."
          ></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn-cancel" (click)="closeModal()">H·ªßy</button>
        <button type="button" class="btn-primary" (click)="submitEdit()">
          <i class="fas fa-save"></i>
          L∆∞u thay ƒë·ªïi
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Modal Backdrop -->
<div class="modal-backdrop" *ngIf="showReplyModal || showEditModal"></div>
